<!DOCTYPE html>
<html lang="ja">

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="この章では、Android (Java) におけるアーキテクチャ設計の指針を解説すると共に、この設計を促進するための DI (Dependency Injection) について解説します。" />
    <meta name=viewport content="width=device-width, initial-scale=1">
    <!-- ogp for twitter -->
    <meta content="@mixi_engineers" name="twitter:site" />
    <meta content="summary" name="twitter:card" />
    
    <meta content="アーキテクチャ設計と DI - r21nomi/AndroidTraining" name="twitter:title" />
    
    <meta content="この章では、Android (Java) におけるアーキテクチャ設計の指針を解説すると共に、この設計を促進するための DI (Dependency Injection) について解説します。" name="twitter:description" />
    <meta content="/assets/logo.png" name="twitter:image:src" />
    <!-- ogp -->
    <meta content="r21nomi/AndroidTraining" property="og:site_name" />
    <meta content="article" property="og:type" />
    <meta content="/assets/logo.png" property="og:image" />
    
    <meta content="アーキテクチャ設計と DI - r21nomi/AndroidTraining" name="og:title" />
    
    <meta content="/advanced/3.02.architecture-and-di.html" property="og:url" />
    <meta content="この章では、Android (Java) におけるアーキテクチャ設計の指針を解説すると共に、この設計を促進するための DI (Dependency Injection) について解説します。" property="og:description" />
    
    <meta name="keyword" content="android, training, 基礎, スキル, 開発, developer, プログラミング, Dependency Injection, アーキテクチャ, DIコンテナ" />
    

    <meta name="go-import" content="github.com/mixi-inc/AndroidTraining git https://github.com/mixi-inc/AndroidTraining.git">
    <script src="/AndroidTraining/bower_components/webcomponentsjs/webcomponents.js"></script>
    
    <link rel="stylesheet" type="text/css" media="screen" href="/AndroidTraining/stylesheets/main.css">
    <link rel="shortcut icon" href="/AndroidTraining/assets/favicon.ico" />
    <link rel="import" href="/AndroidTraining/bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
    <link rel="import" href="/AndroidTraining/bower_components/paper-drawer-panel/paper-drawer-panel.html">
    <link rel="import" href="/AndroidTraining/bower_components/paper-header-panel/paper-header-panel.html">
    <link rel="import" href="/AndroidTraining/bower_components/paper-toolbar/paper-toolbar.html">
    <link rel="import" href="/AndroidTraining/bower_components/paper-menu/paper-menu.html">
    <link rel="import" href="/AndroidTraining/bower_components/paper-item/paper-item.html">
    <link rel="import" href="/AndroidTraining/bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="/AndroidTraining/bower_components/iron-icons/iron-icons.html">
    <style is="custom-style">
        paper-scroll-header-panel:not([style-scope]):not(.style-scope) {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        paper-toolbar.tall .bottom:not([style-scope]):not(.style-scope) {
            font-size: 40px;
            margin-left: 60px;

            -webkit-transform-origin: left center;
            transform-origin: left center;
        }

        .content:not([style-scope]):not(.style-scope) {
            padding: 8px;
        }

        .spacer:not([style-scope]):not(.style-scope) {
            -ms-flex: 1 1 0.000000001px;
            -webkit-flex: 1;
            flex: 1;
            -webkit-flex-basis: 0.000000001px;
            flex-basis: 0.000000001px;
        }

    </style>
    <title>アーキテクチャ設計と DI - r21nomi/AndroidTraining</title>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-50931519-13', 'auto');
    ga('send', 'pageview');
    </script>
  </head>

  <body itemscope itemtype="http://schema.org/Article" fullbleed layout vertical>

    <paper-drawer-panel selected="main" >
      <!-- MENU -->
      <paper-header-panel mode="seamed" drawer class="drawer">
        <nav>
    <ol class="chapter_navigation">
        <a href="/AndroidTraining/">Home</a>
        <li>まえがき</li>
        <ol class="section_navigation">
            
            
            <li><a href="/AndroidTraining/introductions/1.01.about-android-os.html">Android-OSについて</a></li>
            
            <li><a href="/AndroidTraining/introductions/1.02.prepare-for-development.html">開発環境の準備</a></li>
            
            <li><a href="/AndroidTraining/introductions/1.03.create-project-for-android-studio.html">プロジェクトの作成</a></li>
            
            <li><a href="/AndroidTraining/introductions/1.04.basic-knowledge.html">Androidの基礎知識</a></li>
            
            <li><a href="/AndroidTraining/introductions/1.05.how-to-build-for-gradle.html">Android のビルドについて(Gradle)</a></li>
            
        </ol>
        <li>基礎編</li>
        <ol class="section_navigation">
            
            
            <li><a href="/AndroidTraining/fundamentals/2.01.create-layout.html">アプリのレイアウト作成</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.02.activity-and-fragment.html">ActivityとFragment</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.03.application-resource-management.html">アプリのリソース管理</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.04.messaging-and-notification.html">メッセージングと通知</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.05.actionbar-and-interaction-control.html">ActionBarとインタラクション制御</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.06.listView-and-viewPager.html">ListViewとViewPager</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.07.serialize-and-collection-and-perpetuation.html">直列化とコレクション、永続化</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.08.async-processing.html">非同期処理</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.09.network-access.html">ネットワーク通信</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.10.database.html">データベース</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.11.testing-for-android-studio.html">テスト(AndroidStudio)</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.11.testing.html">テスト</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.12.handler-and-looper.html">HandlerとLooper</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.13.webView.html">WebView</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.14.accountmanager.html">AccountManager</a></li>
            
            <li><a href="/AndroidTraining/fundamentals/2.15.advance-contentprovider.html">ContentProviderの発展</a></li>
            
        </ol>
        <li>実務編</li>
        <ol class="section_navigation">
            
            
            <li><a href="/AndroidTraining/advanced/3.01.build-for-eclipse.html">デバッグと自動ビルド(Eclipse)</a></li>
            
            <li><a href="/AndroidTraining/advanced/3.01.build-for-gradle.html">自動ビルド(Android Studio)</a></li>
            
            <li><a href="/AndroidTraining/advanced/3.02.architecture-and-di.html">アーキテクチャ設計と DI</a></li>
            
            <li><a href="/AndroidTraining/advanced/3.03.advanced-layout.html">続・アプリのレイアウト作成</a></li>
            
            <li><a href="/AndroidTraining/advanced/3.04.user-interface.html">ユーザインタフェース設計</a></li>
            
            <li><a href="/AndroidTraining/advanced/3.05.security.html">セキュリティ</a></li>
            
            <li><a href="/AndroidTraining/advanced/3.06.google-api.html">Google API</a></li>
            
            <li><a href="/AndroidTraining/advanced/3.07.google-play-services.html">Google Play Services</a></li>
            
            <li><a href="/AndroidTraining/advanced/3.08.cloud-sync.html">クラウド同期</a></li>
            
        </ol>
        <li>デザイナー編</li>
        <ol>
        </ol>
    </ol>
    <ol class="appex_navigation">
        <li>付録</li>
        <ol class="section_navigation">
            
            
            <li><a href="/AndroidTraining/appendix/A.01.import-from-git-for-eclipse.html">Git リポジトリからのプロジェクトのインポート</a></li>
            
            <li><a href="/AndroidTraining/appendix/A.02.basic-java.html">Java の文法の基礎</a></li>
            
            <li><a href="/AndroidTraining/appendix/A.03.how-to-create-avd.html">仮想デバイスの作成</a></li>
            
            <li><a href="/AndroidTraining/appendix/A.04.advanced-java.html">Javaの活用</a></li>
            
        </ol>
    </ol>
</nav>

      </paper-header-panel>
      <paper-scroll-header-panel main condenses>
        <!-- HEADER -->
        <paper-toolbar class="mainheader tall" role="toolbar">
    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>

    <span class="title"></span>

    <a id="forkme_banner" href="https://github.com/mixi-inc/AndroidTraining" role="button">
        <paper-icon-button src="/AndroidTraining/images/blacktocat.png"></paper-icon-button> <span>View on GitHub</span>
    </a>

    <div class="middle title">r21nomi/AndroidTraining</div>
    <div class="bottom title">アーキテクチャ設計と DI</div>
</paper-toolbar>


<div id="description" itemprop="description">この章では、Android (Java) におけるアーキテクチャ設計の指針を解説すると共に、この設計を促進するための DI (Dependency Injection) について解説します。</div>



        <!-- MAIN CONTENT -->
        <div id="main_content_wrap" class="content outer" itemprop="articleBody">
          <section id="main_content" class="inner">
            <h2 id="section">目次</h2>

<ul>
  <li><a href="#アーキテクチャ設計">アーキテクチャ設計</a>
    <ul>
      <li><a href="#Android フレームワークの特徴">Android フレームワークの特徴</a></li>
      <li><a href="#パッケージの命名">パッケージの命名</a></li>
    </ul>
  </li>
  <li><a href="#Dependency Injection">Dependency Injection</a>
    <ul>
      <li><a href="#DI とは">DI とは</a></li>
      <li><a href="#様々な DI コンテナ">様々な DI コンテナ</a></li>
      <li><a href="#Android における DI コンテナの使用">Android における DI コンテナの使用</a></li>
    </ul>
  </li>
</ul>

<h2 id="section-1">アーキテクチャ設計</h2>

<p>この項では、Android アプリのアーキテクチャの設計指針について解説します。</p>

<h3 id="android-">Android フレームワークの特徴</h3>

<p>Android フレームワークは、MVC フレームワークに基いて設計されています。<br />
Activity や Fragment は Controller の役割を果たし、Button や TextView は文字通り View の役割を果たしています。</p>

<p>これまでのサンプルコードでは、Activity や Fragment でイベントを受け取って、その処理をも Controller の中で実行していましたが、このようにして拡張を行うと、往々にして Activity や Fragment の役割が増え続け、肥え太ったクラスが出来上がってしまいます。<br />
また、Activity や Fragment ですべてを請け負ってしまうと、非常にテストがしづらくなります。</p>

<p>このようなコードは保守性を損なうため、予め以下の様な指針に沿って、適切にレイヤ分けを行うことを強くお奨めします。</p>

<h3 id="section-2">レイヤの分離</h3>

<p>MVC フレームワークにおけるレイヤの分離方法を下記のようにすることを考えます。</p>

<dl>
<dt>ビジネスロジック層(Model)</dt>
<dd>設定を保存、認証する、日記を投稿する等々のユースケースの動詞にあたる処理を行います。</dd>
<dt>プレゼンテーション層(View)</dt>
<dd>画面レイアウト、アニメーション、View コンポーネントの設定を行います。<br />
View コンポーネント間の連携(トグルする等)もこのレイヤになります。<br />
Androidでは、理想的には View コンポーネント間で連携する必要がある場合、ViewGroup で纏めて独立した View として定義したい所ですが、現実的には再利用の当ても無い View を一々作っていくのはコストが高い為、<br />
それらの処理を Helper クラスに委譲して Activity や Fragment 等コントローラ層のクラスから使用します。
</dd>
<dt>コントローラ層(Controller)</dt>
<dd>プレゼンテーション層、ビジネスロジック層間の相互処理と、画面遷移処理を行います。<br />
Androidにおいては、Activity や Fragment で行う View コンポーネントのイベントハンドラからビジネスロジック層を呼び出す処理やstartActivity*、onActivityResult の処理になります。Adapter や BroadcastReceiver もこのレイヤです。<br />
また、プレゼンテーション層とビジネスロジック層の間でデータ構造の不一致が起きる場合(頻繁に起きる)、データ構造変換もこのレイヤで行います。<br />
Android の場合、それらの処理も Helper クラス(Converter クラスとしても良い)に委譲します。<br />
アプリの規模が大きくなるにつれ、Activity や Fragment が大きくなる問題が有りますが、それはプレゼンテーション層とビジネスロジック層の切り分けが出来ていないからです。
</dd>
</dl>

<h3 id="section-3">パッケージの命名</h3>

<p>アプリの持つパッケージ名 (AndroidManifest に宣言するパッケージ名) 以下の名前空間を、次のように命名すると良いでしょう。</p>

<table>
  <thead>
    <tr>
      <th>名前</th>
      <th>意味</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">&lt;package_name&gt;</code>.app.<code class="highlighter-rouge">&lt;domain&gt;</code>.view</td>
      <td>View コンポーネントの場所</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">&lt;package_name&gt;</code>.app.<code class="highlighter-rouge">&lt;domain&gt;</code>.ui</td>
      <td>Controller コンポーネントの場所</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">&lt;package_name&gt;</code>.app.<code class="highlighter-rouge">&lt;domain&gt;</code>.ui.helper</td>
      <td>Controller から移譲される様々な処理の場所</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">&lt;package_name&gt;</code>.app.<code class="highlighter-rouge">&lt;domain&gt;</code>.ui.state</td>
      <td>UI の状態を表す State オブジェクトの場所</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">&lt;package_name&gt;</code>.app.<code class="highlighter-rouge">&lt;domain&gt;</code>.entity</td>
      <td>Model で取り扱うデータ構造の場所</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">&lt;package_name&gt;</code>.app.<code class="highlighter-rouge">&lt;domain&gt;</code>.model</td>
      <td>Model の場所</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">&lt;package_name&gt;</code>.app.<code class="highlighter-rouge">&lt;domain&gt;</code>.service</td>
      <td>Service コンポーネントの場所</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">&lt;package_name&gt;</code>.app.<code class="highlighter-rouge">&lt;domain&gt;</code>.receiver</td>
      <td>BroadcastReceiver コンポーネントの場所</td>
    </tr>
  </tbody>
</table>

<h2 id="dependency-injection-di">Dependency Injection (DI)</h2>

<p>この項では、一般的な Dependency Injection の概要と、Android での使用について解説します。</p>

<h3 id="di-">DI とは</h3>

<p>Dependency Injection (DI) とは、コンポーネント(クラス)の直接の依存関係を取り除き、実行時やコンパイル時にその依存関係を注入するデザインパターンのことです。<br />
このようにすることで、各コンポーネントはインタフェースへ依存するようになり、保守性が向上します。<br />
インタフェースの実装クラスを差し替えることが容易にできるようになるので、テスト時におけるオブジェクトのモックやスタブへの差し替えもずっと楽に行えるようになります。</p>

<h3 id="di--1">様々な DI コンテナ</h3>

<p>現在、下記に挙げる DI コンテナが提供されています。</p>

<ul>
  <li>Java で使用する DI コンテナ
    <ul>
      <li><a href="https://code.google.com/p/google-guice/">Google Guice</a></li>
      <li><a href="http://www.springsource.org/spring-framework">Spring Framework</a></li>
      <li><a href="http://www.seasar.org/">Seasar2</a></li>
      <li><a href="https://github.com/square/dagger">Dagger</a></li>
    </ul>
  </li>
  <li>Android 向けのもの
    <ul>
      <li><a href="https://github.com/roboguice/roboguice">RoboGuice</a></li>
      <li><a href="https://github.com/square/dagger">Dagger</a></li>
      <li><a href="https://github.com/hnakagawa/proton">Proton</a></li>
      <li><a href="https://github.com/johncarl81/transfuse">Transfuse</a></li>
      <li><a href="https://code.google.com/p/andro-inject/">Andro-Inject</a></li>
    </ul>
  </li>
</ul>

<h3 id="android--di-">Android における DI コンテナの使用</h3>

<p>今回は、Proton を例にその使い方を見ていきます。</p>

<p>以下は、Activity の実装です。</p>

<pre><code class="language-Java">public class MainActivity extends ProtonActivity {
    // @Inject アノテーションを付与したものに対して、オブジェクトが自動で注入されるので
    // このコード上で具象クラスを new する必要がない。
    // これによって、このクラスと具象クラスの依存関係がなくなり、インタフェースへと依存することになることで
    // コンポーネントの差し替えが容易に行えるようになる
    @Inject
    private OptionsItemSelectionHandler mOptionsMenuHandler;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        getMenuInflater().inflate(R.menu.main, menu);
        return super.onCreateOptionsMenu(menu);
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        if (mOptionsMenuHandler.handle(item)) {
            return true;
        }

        return super.onOptionsItemSelected(item);
    }
}
</code></pre>

<p><code class="highlighter-rouge">@Inject</code>アノテーションを付与したフィールドに対して、実行時にオブジェクトが注入されます。<br />
この例では、<code class="highlighter-rouge">OptionsItemSelectionHandler</code>インタフェースを実装したクラスのインスタンスが注入されるようになっています。</p>

<p><code class="highlighter-rouge">OptionsItemSelectionHandler</code>インタフェースに対して、どの具象クラスを注入するか、という情報を設定するクラスは次のとおりです。</p>

<pre><code class="language-Java">public class DependencyInjectionSampleModule extends DefaultModule {
    @Override
    protected void configure() {
        super.configure();

        // どのクラスがどのインタフェースに従っているかと、どのコンポーネントのライフサイクルに依存するかを規約として決める
        bind(OptionsItemSelectionHandler.class).to(MainOptionsItemSelectionHandler.class).in(ContextScoped.class);
    }
}
</code></pre>

<p>このクラスの<code class="highlighter-rouge">configure()</code>は、DI コンテナの初期化の時に実行されます。<br />
通常、DI コンテナの初期化はアプリケーションの開始時に行うため、下記のように<code class="highlighter-rouge">Application</code>クラスを継承した独自のクラスを定義します。</p>

<pre><code class="language-Java">// アプリケーションの Context を表すクラス
// アプリケーション全体に及ぶ規約をここで設定する
public class DependencyInjectionSampleApplication extends Application {
    // アプリケーションが開始されるときに呼ばれるライフサイクルコールバック
    @Override
    public void onCreate() {
        super.onCreate();

        // DI コンテナの初期化
        Proton.initialize(this, new DependencyInjectionSampleModule());
    }
}
</code></pre>

<p>独自のアプリケーションクラスを定義する場合、AndroidManifest にもその旨を示す宣言をします。</p>

<div class="language-xml highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;manifest</span>
    <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">package=</span><span class="s">"jp.mixi.sample.di"</span>
    <span class="na">android:versionCode=</span><span class="s">"1"</span>
    <span class="na">android:versionName=</span><span class="s">"1.0"</span> <span class="nt">&gt;</span>

    <span class="nt">&lt;uses-sdk</span>
        <span class="na">android:minSdkVersion=</span><span class="s">"8"</span>
        <span class="na">android:targetSdkVersion=</span><span class="s">"17"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;application</span>
        <span class="na">android:allowBackup=</span><span class="s">"true"</span>
        <span class="na">android:icon=</span><span class="s">"@drawable/ic_launcher"</span>
        <span class="na">android:label=</span><span class="s">"@string/app_name"</span>
        <span class="na">android:theme=</span><span class="s">"@style/AppTheme"</span>
        <span class="na">android:name=</span><span class="s">"jp.mixi.sample.di.DependencyInjectionSampleApplication"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;activity</span>
            <span class="na">android:name=</span><span class="s">"jp.mixi.sample.di.ui.MainActivity"</span>
            <span class="na">android:label=</span><span class="s">"@string/app_name"</span> <span class="nt">&gt;</span>
            <span class="nt">&lt;intent-filter&gt;</span>
                <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.MAIN"</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">"android.intent.category.LAUNCHER"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/intent-filter&gt;</span>
        <span class="nt">&lt;/activity&gt;</span>
    <span class="nt">&lt;/application&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</code></pre>
</div>

          </section>
        </div>

        <!-- FOOTER  -->
        <div id="footer_wrap" class="outer">
          <footer class="inner">
  <p class="license">Portions of this page are reproduced from work created and <a href="https://code.google.com/p/android/">shared by the Android Open Source Project</a> and used according to terms described in the <a href="http://creativecommons.org/licenses/by/2.5/">Creative Commons2.5 Attribution License</a>.</p>
  <p class="license">
  This work is licensed under a <a rel="license" itemprop="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. 
  <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
  </p>
  <p class="copyright">Androidtraining maintained by <a href="https://github.com/mixi-inc" itemprop="author">mixi-inc</a></p>
  <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>

</footer>

        </div>
      </paper-scroll-header-panel>
    </paper-drawer-panel>
    <script>
        // custom transformation: scale header's title
        var title = document.querySelectorAll('.title')[2];
        addEventListener('paper-header-transform', function(e) {
            var d = e.detail;
            var m = d.height - d.condensedHeight;
            var scale = Math.max(0.75, (m - d.y) / (m / 0.25)  + 0.75);

            Polymer.Base.transform('scale(' + scale + ') translateZ(0)', title);
        });

    </script>
</body>
</html>
